<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>힐링K 위젯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .healing-widget {
            max-width: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        
        .widget-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .widget-logo {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .widget-subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .weather-main {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        
        .current-weather {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .weather-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weather-icon {
            font-size: 2rem;
        }
        
        .weather-info h3 {
            font-size: 1rem;
            margin-bottom: 2px;
        }
        
        .weather-desc {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .temperature {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .weather-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .ranking-preview {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .ranking-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 0.8rem;
        }
        
        .rank-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rank-number {
            background: rgba(255,255,255,0.2);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .widget-footer {
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .update-time {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 8px;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .error {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        /* 반응형 */
        @media (max-width: 480px) {
            .healing-widget {
                max-width: 100%;
                margin: 10px;
                border-radius: 15px;
            }
            
            .current-weather {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .weather-left {
                flex-direction: column;
                text-align: center;
            }
        }
        
        /* 애니메이션 */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="healing-widget" id="healingWidget">
        <div class="widget-header">
            <div class="widget-logo">🏔️ 힐링K</div>
            <div class="widget-subtitle">실시간 관광 날씨</div>
        </div>
        
        <div id="widget-content">
            <div class="loading pulse">실시간 데이터 로딩 중...</div>
        </div>
        
        <div class="widget-footer">
            <div class="update-time" id="updateTime">업데이트 중...</div>
            <button class="refresh-btn" onclick="refreshWidget()">새로고침</button>
        </div>
    </div>

    <script>
        let currentData = null;
        
        // 위젯 초기화
        document.addEventListener('DOMContentLoaded', function() {
            loadWidgetData();
            
            // 5분마다 자동 업데이트
            setInterval(loadWidgetData, 5 * 60 * 1000);
        });
        
        async function loadWidgetData() {
            const content = document.getElementById('widget-content');
            const updateTime = document.getElementById('updateTime');
            
            try {
                // 서울 날씨 기본 + 랭킹 TOP 3
                const [seoulData, rankingData] = await Promise.allSettled([
                    fetch('/api/combined?region=서울').then(r => r.json()),
                    fetch('/api/ranking').then(r => r.json())
                ]);
                
                const seoul = seoulData.status === 'fulfilled' ? seoulData.value.data : null;
                const ranking = rankingData.status === 'fulfilled' ? rankingData.value.data?.slice(0, 3) : null;
                
                renderWidget(seoul, ranking);
                updateTime.textContent = new Date().toLocaleTimeString('ko-KR');
                
            } catch (error) {
                content.innerHTML = `
                    <div class="error">
                        데이터 로드 실패<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        function renderWidget(seoul, ranking) {
            const content = document.getElementById('widget-content');
            
            // 날씨 아이콘 결정
            let weatherIcon = '🌤️';
            if (seoul?.weather) {
                if (seoul.weather.sky === '맑음') weatherIcon = '☀️';
                else if (seoul.weather.sky === '구름많음') weatherIcon = '⛅';
                else if (seoul.weather.sky === '흐림') weatherIcon = '☁️';
                if (seoul.weather.precipitation !== '없음') weatherIcon = '🌧️';
            }
            
            // 대기질 상태 아이콘
            let airIcon = '💨';
            if (seoul?.airQuality) {
                if (seoul.airQuality.status === '좋음') airIcon = '😊';
                else if (seoul.airQuality.status === '보통') airIcon = '😐';
                else if (seoul.airQuality.status === '나쁨') airIcon = '😷';
                else if (seoul.airQuality.status === '매우나쁨') airIcon = '😵';
            }
            
            let html = '';
            
            // 메인 날씨 정보
            if (seoul?.weather) {
                html += `
                    <div class="weather-main fade-in">
                        <div class="current-weather">
                            <div class="weather-left">
                                <div class="weather-icon">${weatherIcon}</div>
                                <div class="weather-info">
                                    <h3>서울 현재 날씨</h3>
                                    <div class="weather-desc">${seoul.weather.sky} • ${seoul.weather.precipitation}</div>
                                </div>
                            </div>
                            <div class="temperature">${seoul.weather.temperature}°C</div>
                        </div>
                        <div class="weather-details">
                            <span>${airIcon} ${seoul.airQuality?.status || '정보없음'}</span>
                            <span>🎯 추천도: ${seoul.recommendation || '보통'}</span>
                            <span>📊 ${seoul.score || 0}점</span>
                        </div>
                    </div>
                `;
            }
            
            // TOP 3 랭킹
            if (ranking && ranking.length > 0) {
                html += `
                    <div class="ranking-preview fade-in">
                        <div class="ranking-title">
                            🏆 오늘의 추천 여행지
                        </div>
                `;
                
                ranking.forEach(item => {
                    const rankIcon = item.rank === 1 ? '🥇' : item.rank === 2 ? '🥈' : '🥉';
                    html += `
                        <div class="ranking-item">
                            <div class="rank-left">
                                <div class="rank-number">${item.rank}</div>
                                <span>${item.region}</span>
                            </div>
                            <div>
                                <span style="margin-right: 5px;">${rankIcon}</span>
                                <span>${item.score}점</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // 추가 정보
            html += `
                <div class="ranking-preview fade-in">
                    <div class="ranking-title">
                        ✨ 실시간 전국 현황
                    </div>
                    <div class="ranking-item">
                        <span>🌡️ 전국 평균 기온</span>
                        <span>${seoul?.weather?.temperature || 20}°C</span>
                    </div>
                    <div class="ranking-item">
                        <span>💨 대기질 좋은 지역</span>
                        <span>${ranking ? ranking.filter(r => r.airQuality === '좋음').length : 0}곳</span>
                    </div>
                    <div class="ranking-item">
                        <span>☀️ 맑은 날씨 지역</span>
                        <span>${ranking ? ranking.filter(r => r.weather?.includes('맑음')).length : 0}곳</span>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function refreshWidget() {
            const btn = event.target;
            btn.textContent = '새로고침 중...';
            btn.disabled = true;
            
            loadWidgetData().finally(() => {
                btn.textContent = '새로고침';
                btn.disabled = false;
            });
        }
        
        // 전체 대시보드로 이동
        function openFullDashboard() {
            window.open('/', '_blank');
        }
    </script>
</body>
</html>
