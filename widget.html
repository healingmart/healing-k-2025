<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íë§K ìœ„ì ¯</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .healing-widget {
            max-width: 400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        
        .widget-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .widget-logo {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .widget-subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .weather-main {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        
        .current-weather {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .weather-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weather-icon {
            font-size: 2rem;
        }
        
        .weather-info h3 {
            font-size: 1rem;
            margin-bottom: 2px;
        }
        
        .weather-desc {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .temperature {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .weather-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .ranking-preview {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .ranking-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 0.8rem;
        }
        
        .rank-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rank-number {
            background: rgba(255,255,255,0.2);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .widget-footer {
            text-align: center;
            font-size: 0.7rem;
            opacity: 0.8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .update-time {
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 8px;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .error {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .healing-widget {
                max-width: 100%;
                margin: 10px;
                border-radius: 15px;
            }
            
            .current-weather {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .weather-left {
                flex-direction: column;
                text-align: center;
            }
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="healing-widget" id="healingWidget">
        <div class="widget-header">
            <div class="widget-logo">ğŸ”ï¸ íë§K</div>
            <div class="widget-subtitle">ì‹¤ì‹œê°„ ê´€ê´‘ ë‚ ì”¨</div>
        </div>
        
        <div id="widget-content">
            <div class="loading pulse">ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </div>
        
        <div class="widget-footer">
            <div class="update-time" id="updateTime">ì—…ë°ì´íŠ¸ ì¤‘...</div>
            <button class="refresh-btn" onclick="refreshWidget()">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <script>
        let currentData = null;
        
        // ìœ„ì ¯ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadWidgetData();
            
            // 5ë¶„ë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
            setInterval(loadWidgetData, 5 * 60 * 1000);
        });
        
        async function loadWidgetData() {
            const content = document.getElementById('widget-content');
            const updateTime = document.getElementById('updateTime');
            
            try {
                // ì„œìš¸ ë‚ ì”¨ ê¸°ë³¸ + ë­í‚¹ TOP 3
                const [seoulData, rankingData] = await Promise.allSettled([
                    fetch('/api/combined?region=ì„œìš¸').then(r => r.json()),
                    fetch('/api/ranking').then(r => r.json())
                ]);
                
                const seoul = seoulData.status === 'fulfilled' ? seoulData.value.data : null;
                const ranking = rankingData.status === 'fulfilled' ? rankingData.value.data?.slice(0, 3) : null;
                
                renderWidget(seoul, ranking);
                updateTime.textContent = new Date().toLocaleTimeString('ko-KR');
                
            } catch (error) {
                content.innerHTML = `
                    <div class="error">
                        ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨<br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        function renderWidget(seoul, ranking) {
            const content = document.getElementById('widget-content');
            
            // ë‚ ì”¨ ì•„ì´ì½˜ ê²°ì •
            let weatherIcon = 'ğŸŒ¤ï¸';
            if (seoul?.weather) {
                if (seoul.weather.sky === 'ë§‘ìŒ') weatherIcon = 'â˜€ï¸';
                else if (seoul.weather.sky === 'êµ¬ë¦„ë§ìŒ') weatherIcon = 'â›…';
                else if (seoul.weather.sky === 'íë¦¼') weatherIcon = 'â˜ï¸';
                if (seoul.weather.precipitation !== 'ì—†ìŒ') weatherIcon = 'ğŸŒ§ï¸';
            }
            
            // ëŒ€ê¸°ì§ˆ ìƒíƒœ ì•„ì´ì½˜
            let airIcon = 'ğŸ’¨';
            if (seoul?.airQuality) {
                if (seoul.airQuality.status === 'ì¢‹ìŒ') airIcon = 'ğŸ˜Š';
                else if (seoul.airQuality.status === 'ë³´í†µ') airIcon = 'ğŸ˜';
                else if (seoul.airQuality.status === 'ë‚˜ì¨') airIcon = 'ğŸ˜·';
                else if (seoul.airQuality.status === 'ë§¤ìš°ë‚˜ì¨') airIcon = 'ğŸ˜µ';
            }
            
            let html = '';
            
            // ë©”ì¸ ë‚ ì”¨ ì •ë³´
            if (seoul?.weather) {
                html += `
                    <div class="weather-main fade-in">
                        <div class="current-weather">
                            <div class="weather-left">
                                <div class="weather-icon">${weatherIcon}</div>
                                <div class="weather-info">
                                    <h3>ì„œìš¸ í˜„ì¬ ë‚ ì”¨</h3>
                                    <div class="weather-desc">${seoul.weather.sky} â€¢ ${seoul.weather.precipitation}</div>
                                </div>
                            </div>
                            <div class="temperature">${seoul.weather.temperature}Â°C</div>
                        </div>
                        <div class="weather-details">
                            <span>${airIcon} ${seoul.airQuality?.status || 'ì •ë³´ì—†ìŒ'}</span>
                            <span>ğŸ¯ ì¶”ì²œë„: ${seoul.recommendation || 'ë³´í†µ'}</span>
                            <span>ğŸ“Š ${seoul.score || 0}ì </span>
                        </div>
                    </div>
                `;
            }
            
            // TOP 3 ë­í‚¹
            if (ranking && ranking.length > 0) {
                html += `
                    <div class="ranking-preview fade-in">
                        <div class="ranking-title">
                            ğŸ† ì˜¤ëŠ˜ì˜ ì¶”ì²œ ì—¬í–‰ì§€
                        </div>
                `;
                
                ranking.forEach(item => {
                    const rankIcon = item.rank === 1 ? 'ğŸ¥‡' : item.rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                    html += `
                        <div class="ranking-item">
                            <div class="rank-left">
                                <div class="rank-number">${item.rank}</div>
                                <span>${item.region}</span>
                            </div>
                            <div>
                                <span style="margin-right: 5px;">${rankIcon}</span>
                                <span>${item.score}ì </span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            // ì¶”ê°€ ì •ë³´
            html += `
                <div class="ranking-preview fade-in">
                    <div class="ranking-title">
                        âœ¨ ì‹¤ì‹œê°„ ì „êµ­ í˜„í™©
                    </div>
                    <div class="ranking-item">
                        <span>ğŸŒ¡ï¸ ì „êµ­ í‰ê·  ê¸°ì˜¨</span>
                        <span>${seoul?.weather?.temperature || 20}Â°C</span>
                    </div>
                    <div class="ranking-item">
                        <span>ğŸ’¨ ëŒ€ê¸°ì§ˆ ì¢‹ì€ ì§€ì—­</span>
                        <span>${ranking ? ranking.filter(r => r.airQuality === 'ì¢‹ìŒ').length : 0}ê³³</span>
                    </div>
                    <div class="ranking-item">
                        <span>â˜€ï¸ ë§‘ì€ ë‚ ì”¨ ì§€ì—­</span>
                        <span>${ranking ? ranking.filter(r => r.weather?.includes('ë§‘ìŒ')).length : 0}ê³³</span>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        function refreshWidget() {
            const btn = event.target;
            btn.textContent = 'ìƒˆë¡œê³ ì¹¨ ì¤‘...';
            btn.disabled = true;
            
            loadWidgetData().finally(() => {
                btn.textContent = 'ìƒˆë¡œê³ ì¹¨';
                btn.disabled = false;
            });
        }
        
        // ì „ì²´ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
        function openFullDashboard() {
            window.open('/', '_blank');
        }
    </script>
</body>
</html>
